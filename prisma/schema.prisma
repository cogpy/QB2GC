// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String   @db.VarChar(255)
  content   String?
  published Boolean  @default(false)
  author    User     @relation(fields: [authorId], references: [id])
  authorId  Int
}

model Profile {
  id     Int     @id @default(autoincrement())
  bio    String?
  user   User    @relation(fields: [userId], references: [id])
  userId Int     @unique
}

model User {
  id      Int      @id @default(autoincrement())
  email   String   @unique
  name    String?
  posts   Post[]
  profile Profile?
}

model Taxation {
  id                Int              @id @default(autoincrement())
  title             String
  taxRate           Float
  effectiveFrom     DateTime
  effectiveTo       DateTime
  createdBy         String
  documentNumber    String?
  remarks           String?
  isActive          Boolean          @default(true)
  
  // GnuCash sync tracking
  gcSyncStatus      SyncStatus       @default(PENDING)
  gcSyncedAt        DateTime?
  gcAccountId       String?                    // GnuCash account ID if synced
  gcSyncError       String?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Nested relations
  employeeInfo      EmployeeInfo     @relation(fields: [employeeInfoId], references: [id])
  employeeInfoId    Int
  employeeAddress   EmployeeAddress  @relation(fields: [employeeAddressId], references: [id])
  employeeAddressId Int
}

model EmployeeInfo {
  id            Int        @id @default(autoincrement())
  name          String
  age           Int
  designation   String
  maritalStatus String
  department    String?
  joiningDate   DateTime
  isActive      Boolean     @default(true)

  taxations     Taxation[]
}

model EmployeeAddress {
  id        Int       @id @default(autoincrement())
  houseNo   String
  street    String
  city      String
  state     String
  country   String
  pinCode   String
  landmark  String?

  isActive  Boolean   @default(true)
  taxations Taxation[]
}

//Account 
enum AccountType{
  Current
  Savings
  Fixed_deposit
}

enum AccountStatus{
  Active
  Inactive
}

enum SyncStatus{
  PENDING
  IN_PROGRESS
  SYNCED
  FAILED
}

model Account {
  id             String        @id @default(uuid()) @db.Uuid
  holderName     String
  accountNumber  String        
  type           AccountType
  status         AccountStatus @default(Active)
  balance        Float
  openedAt       DateTime
  isActive       Boolean       @default(true)
  
  // GnuCash sync tracking
  gcSyncStatus   SyncStatus    @default(PENDING)
  gcSyncedAt     DateTime?
  gcAccountId    String?                    // GnuCash account ID if synced
  gcSyncError    String?
  
  contactInfo    ContactInfo?  @relation(fields: [contactInfoId], references: [id])
  contactInfoId  String?       @unique @db.Uuid

  kycDetails     KycDetails?   @relation(fields: [kycDetailsId], references: [id])
  kycDetailsId   String?       @unique @db.Uuid

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model ContactInfo {
  id         String   @id @default(uuid()) @db.Uuid
  phone      String
  email      String
  address    String
  city       String
  pincode    String
  country    String
  isActive   Boolean  @default(true)

  account    Account?
}

model KycDetails {
  id              String   @id @default(uuid()) @db.Uuid
  panCardNumber   String  
  
  isVerified      Boolean  @default(false)

  account         Account?
}

model student {
  id    String @id @default(uuid())
  name   String
  age    Int
  class   Int
  subject String @db.Uuid
  subject_relation  subject @relation(fields: [subject], references: [id])
}

model subject {
  id   String @id @default(uuid()) @db.Uuid
  sub_name String
  students student[]
}

model QBClass {
  id               String   @id @default(uuid()) @db.Uuid
  qbId             String?   @unique            // Maps to QB's "Id"
  name             String                     // Maps to QB's "Name"
  fullName         String?                    // Maps to QB's "FullyQualifiedName"
  isSubClass       Boolean   @default(false)   // Maps to QB's "SubClass"
  isActive         Boolean   @default(true)    // Maps to QB's "Active"
  domainSource     String?                    // Maps to QB's "domain"
  versionToken     Int       @default(0)       // Maps to QB's "SyncToken" (converted to Int)
  isSparse         Boolean   @default(false)   // Maps to QB's "sparse"

  // GnuCash sync tracking
  gcSyncStatus     SyncStatus @default(PENDING)
  gcSyncedAt       DateTime?
  gcAccountId      String?                    // GnuCash account ID if synced
  gcSyncError      String?

  createdAt        DateTime  @default(now())   // Maps to QB MetaData.CreateTime
  updatedAt        DateTime  @updatedAt        // Maps to QB MetaData.LastUpdatedTime
}

// GnuCash Sync Log for tracking all sync operations
model GnuCashSyncLog {
  id               String      @id @default(uuid()) @db.Uuid
  entityType       String                        // "Class", "Account", "Taxation"
  entityId         String                        // ID of the entity being synced
  syncStatus       SyncStatus  @default(PENDING)
  syncDirection    String      @default("qb_to_gc") // "qb_to_gc" or "gc_to_qb"
  gcFilePath       String?                       // Path to GnuCash file synced to
  errorMessage     String?
  syncStartedAt    DateTime    @default(now())
  syncCompletedAt  DateTime?
  retryCount       Int         @default(0)
  metadata         String?                       // JSON string for additional data
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

// Universal Entity Registry - Maps entities from any external system
model UniversalEntity {
  id                String             @id @default(uuid()) @db.Uuid
  universalType     String                               // Person, Organization, Product, etc.
  sourceSystem      String                               // QuickBooks, Salesforce, SAP, etc.
  sourceEntityType  String                               // Original entity type in source system
  sourceEntityId    String                               // ID in source system
  
  // Core universal fields (JSON-encoded)
  coreData          String                               // JSON with universal core fields
  extendedData      String?                              // JSON with additional fields
  rawData           String?                              // Original raw data from source
  
  // Sync tracking
  syncStatus        SyncStatus         @default(PENDING)
  lastSyncedAt      DateTime?
  syncError         String?
  
  // Metadata
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  isActive          Boolean            @default(true)
  
  // Relations
  mappings          EntityMapping[]
  syncLogs          UniversalSyncLog[]
  
  @@unique([sourceSystem, sourceEntityType, sourceEntityId])
  @@index([universalType])
  @@index([sourceSystem])
}

// Entity Mapping - Maps between entities across systems
model EntityMapping {
  id                  String           @id @default(uuid()) @db.Uuid
  universalEntityId   String           @db.Uuid
  universalEntity     UniversalEntity  @relation(fields: [universalEntityId], references: [id], onDelete: Cascade)
  
  targetSystem        String                               // System being mapped to
  targetEntityType    String                               // Entity type in target system
  targetEntityId      String?                              // ID in target system (null until created)
  
  mappingConfig       String                               // JSON with field mappings
  syncStatus          SyncStatus       @default(PENDING)
  lastSyncedAt        DateTime?
  syncError           String?
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  @@unique([universalEntityId, targetSystem, targetEntityType])
  @@index([targetSystem])
}

// Universal Sync Log - Tracks all cross-system sync operations
model UniversalSyncLog {
  id                  String           @id @default(uuid()) @db.Uuid
  universalEntityId   String?          @db.Uuid
  universalEntity     UniversalEntity? @relation(fields: [universalEntityId], references: [id], onDelete: SetNull)
  
  operation           String                               // create, update, delete, sync
  sourceSystem        String
  targetSystem        String
  
  syncStatus          SyncStatus       @default(PENDING)
  syncDirection       String                               // bidirectional, source_to_target, target_to_source
  
  errorMessage        String?
  syncStartedAt       DateTime         @default(now())
  syncCompletedAt     DateTime?
  retryCount          Int              @default(0)
  
  metadata            String?                              // JSON with additional data
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  @@index([sourceSystem])
  @@index([targetSystem])
  @@index([syncStatus])
}

// System Integration Config - Stores configuration for each integrated system
model SystemIntegration {
  id                String           @id @default(uuid()) @db.Uuid
  systemName        String           @unique                // QuickBooks, Salesforce, etc.
  systemType        String                                  // accounting, crm, erp, etc.
  enabled           Boolean          @default(true)
  
  // Connection config (encrypted credentials)
  connectionConfig  String                                  // JSON with API keys, endpoints, etc.
  authType          String                                  // oauth2, api_key, basic, etc.
  
  // Sync settings
  autoSync          Boolean          @default(false)
  syncInterval      Int?                                    // Sync interval in minutes
  batchSize         Int              @default(10)
  retryAttempts     Int              @default(3)
  
  // Monitoring
  lastSyncAt        DateTime?
  syncEnabled       Boolean          @default(true)
  healthStatus      String           @default("unknown")  // healthy, degraded, down
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([systemType])
  @@index([enabled])
}
